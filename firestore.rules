/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for users, instructors and their associated data.
 * All data is nested under user-specific or instructor-specific paths (/users/{userId}, /instructors/{instructorId}),
 * ensuring that only the authenticated user or the instructor has full access to their respective data.
 * Classes are nested under instructor profiles, and bookings are duplicated under both users and classes
 * for efficient data retrieval and management. Notifications are also nested under the user's path.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user.
 * - /instructors/{instructorId}: Stores instructor profiles, accessible only by the instructor.
 * - /instructors/{instructorId}/classes/{classId}: Stores classes owned by instructors, accessible only by the owning instructor.
 * - /classes/{classId}/bookings/{bookingId}: Stores bookings for classes, accessible by either class or user.
 * - /users/{userId}/bookings/{bookingId}: Stores booking duplicated for users, accessible only by the user.
 * - /users/{userId}/notifications/{notificationId}: Stores notifications for users, accessible only by the user.
 *
 * Key Security Decisions:
 * - User and instructor profiles are private and only accessible by the authenticated user or instructor.
 * - Class creation, update, and deletion are restricted to the owning instructor.
 * - Bookings can be created by anyone (assuming the application handles payment and class availability).
 *   However, access to booking data is restricted to the user who made the booking.
 * - Notifications are private and only accessible by the intended user.
 *
 * Denormalization for Authorization:
 * - Classes documents has an `instructorId` field for authorization.
 * - Bookings documents has `classId` and `userId` for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can access their own user profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get, update, delete) Authenticated user 'user123' can access and modify their own profile.
     * @deny (get, update, delete) Authenticated user 'user456' cannot access user 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return request.auth.uid == userId && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated instructor can access their own instructor profile.
     * @path /instructors/{instructorId}
     * @allow (create) Instructor with ID 'instructor123' can create their own profile.
     * @allow (get, update, delete) Authenticated instructor 'instructor123' can access and modify their own profile.
     * @deny (get, update, delete) Authenticated instructor 'instructor456' cannot access instructor 'instructor123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /instructors/{instructorId} {
      function isOwner(instructorId) {
        return request.auth.uid == instructorId;
      }

      function isExistingOwner(instructorId) {
        return request.auth.uid == instructorId && resource != null;
      }

      allow get: if isOwner(instructorId);
      allow list: if false;
      allow create: if isOwner(instructorId);
      allow update: if isExistingOwner(instructorId);
      allow delete: if isExistingOwner(instructorId);
    }

    /**
     * @description Enforces that only the instructor can manage their own classes.
     * @path /instructors/{instructorId}/classes/{classId}
     * @allow (create) Instructor 'instructor123' can create a class under their profile.
     * @allow (get, update, delete) Instructor 'instructor123' can access and modify class 'classABC' under their profile.
     * @deny (get, update, delete) Instructor 'instructor456' cannot access class 'classABC' under instructor 'instructor123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /instructors/{instructorId}/classes/{classId} {
      function isOwner(instructorId) {
        return request.auth.uid == instructorId;
      }

      function isExistingOwner(instructorId) {
        return request.auth.uid == instructorId && resource != null;
      }
      allow get: if isOwner(instructorId);
      allow list: if isOwner(instructorId);
      allow create: if isOwner(instructorId);
      allow update: if isExistingOwner(instructorId);
      allow delete: if isExistingOwner(instructorId);
    }

    /**
     * @description Allows access to bookings nested under classes.
     * @path /classes/{classId}/bookings/{bookingId}
     * @allow (create) Any authenticated user can create a booking for a class.
     * @allow (get, list) Any authenticated user can get or list a booking for a class.
     * @deny (update, delete) Only a user with appropriate permission can update or delete a booking.
     * @principle Allows public read access, restricts write access.
     */
    match /classes/{classId}/bookings/{bookingId} {

      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null;
      allow update: if false;
      allow delete: if false;
    }

      /**
     * @description Allows access to bookings nested under users.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow (create) Any authenticated user can create a booking for themself.
     * @allow (get, list) Any authenticated user can get or list their own booking.
     * @deny (update, delete) Only the user with appropriate permission can update or delete their booking.
     * @principle Allows public read access, restricts write access.
     */
    match /users/{userId}/bookings/{bookingId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return request.auth.uid == userId && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated user can access their own notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create) User with ID 'user123' can create their own notification.
     * @allow (get, update, delete) Authenticated user 'user123' can access and modify their own notification.
     * @deny (get, update, delete) Authenticated user 'user456' cannot access user 'user123' notification.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/notifications/{notificationId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return request.auth.uid == userId && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}